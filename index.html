<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>课堂娱乐站 · 笑话 / 古诗接句 / 手势舞（仅挥手/点赞/OK，本地版）</title>
<style>
:root{--bg:#f6fbff;--accent:#2bb0ed;--muted:#5b6b7b}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei";background:linear-gradient(180deg,#fff,var(--bg));color:#0e1b2a}
.header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid #eef4fb;background:#fff;position:sticky;top:0;z-index:10}
.logo{font-weight:700;color:var(--accent)}
.tabs{display:flex;gap:8px;margin-left:12px}
.tab{padding:8px 12px;border-radius:10px;cursor:pointer;background:#f7fbff;border:1px solid #e6f0fb}
.tab.active{background:linear-gradient(90deg,#bfefff,#e8f6ff);box-shadow:0 6px 18px rgba(43,176,237,.08)}
.container{max-width:1000px;margin:16px auto;padding:8px}
.card{background:#fff;border-radius:12px;padding:12px;border:1px solid #e9f2fb;box-shadow:0 6px 18px rgba(10,30,60,.03)}
.card.small{padding:8px;font-size:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;cursor:pointer}
.big{font-size:18px;font-weight:600}
.smallmuted{color:var(--muted);font-size:13px}
.hidden{display:none}
.input{padding:8px;border-radius:8px;border:1px solid #e6eef6}
.label{font-size:13px;color:var(--muted)}
.footer{margin-top:12px;color:#6e84a3;font-size:13px}
.bar{height:10px;background:#eef4ff;border-radius:999px;overflow:hidden;border:1px solid #e6eef6}
.bar>div{height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%}
  /* 手势舞附加样式 */
  .mediaWrap{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:900px){.mediaWrap{grid-template-columns:1fr}}
  .badge{display:inline-block;padding:4px 8px;border-radius:9999px;border:1px solid #e6eef6}
  .badge.active{background:linear-gradient(90deg,#bfefff,#e8f6ff);font-weight:700}
  .badge.done{background:#eef7ff;opacity:.9}
  .animBox{width:190px;display:flex;flex-direction:column;align-items:center;gap:6px}
  .animEmoji{font-size:96px;line-height:1;filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}
  .animHint{font-size:12px;color:#fff;opacity:.95}
  .animArrow{font-size:22px;color:#bfe1ff;margin-top:-4px}
  @keyframes waveX{0%,100%{transform:translateX(-12%) rotate(-10deg)}50%{transform:translateX(12%) rotate(12deg)}}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.18)}}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10%)}}
  .anim-waveX{animation:waveX 1.05s ease-in-out infinite}
  .anim-pulse{animation:pulse .9s ease-in-out infinite}
  .anim-bounce{animation:bounce .9s ease-in-out infinite}
.btn.toggled{background:linear-gradient(90deg,#bfefff,#e8f6ff);font-weight:700}
.mirror{transform:scaleX(-1);}
</style>
</head>
<body>
<div class="header">
  <div class="logo">课堂娱乐站 · 笑话 / 古诗接句 / 手势舞（仅挥手/点赞/OK）</div>
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="jokes">笑话</div>
    <div class="tab" data-tab="poems">古诗接句</div>
    <div class="tab" data-tab="gesture">手势舞</div>
  </div>
  <div style="margin-left:auto" class="smallmuted">纯本地 · 无剪刀石头布模块</div>
</div>

<main class="container">

<!-- 笑话 -->
<section id="jokes" class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="big">笑话时间 😂</div>
      <div class="smallmuted">已内置笑话库，支持上传 JSONL/TXT 替换。</div>
    </div>
    <div class="row">
      <button class="btn" id="jokeNext">换一个</button>
      <button class="btn" id="jokeRead">朗读</button>
      <label class="btn">加载外部库<input id="jokeFile" type="file" accept=".jsonl,.txt" style="display:none"></label>
      <button class="btn" id="jokeReset">重置内置库</button>
    </div>
  </div>
  <div style="margin-top:12px" id="jokeText" class="big">加载中…</div>
</section>

<!-- 古诗接句（先选“上一句/下一句”，再作答；答错才可“查看答案”） -->
<section id="poems" class="card hidden" style="margin-top:12px">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="big">古诗接句 📝</div>
      <div class="smallmuted">先选择“上一句/下一句”，再输入对应诗句。答错才会出现“查看答案”。</div>
    </div>
    <div class="row">
      <button class="btn" id="poemChallenge">随机出题</button>
      <span class="smallmuted">当前库：<b id="poemCount">0</b> 首</span>
      <label class="btn">加载古诗库<input id="poemFile" type="file" accept=".jsonl,.json,.txt" style="display:none"></label>
      <button class="btn" id="poemReset">重置古诗库</button>
    </div>
  </div>

  <div style="margin-top:12px" class="card small">
    <div class="smallmuted">题目（随机抽一行）：</div>
    <div id="poemShown" class="big">—</div>
    <div class="smallmuted">作者 / 题目：<span id="poemMeta">—</span></div>

    <div class="row" style="margin-top:8px">
      <label class="label">我要回答：</label>
      <select id="poemDirection" class="input">
        <option value="prev">上一句</option>
        <option value="next">下一句</option>
      </select>
      <span class="smallmuted">（先选方向，再作答）</span>
    </div>

    <div style="margin-top:8px">
      <input id="poemAnswerInput" class="input" style="min-width:260px" placeholder="输入对应诗句（不必加标点）"/>
      <button class="btn" id="poemSubmit">提交</button>
      <button class="btn hidden" id="poemReveal">查看答案</button>
      <div class="bar" style="margin-top:8px;width:280px"><div id="progress" style="width:0%"></div></div>
    </div>
    <pre id="poemAnswer" class="hidden" style="margin-top:8px;padding:8px"></pre>
  </div>
</section>

<!-- 手势舞（精简：仅 挥手 / 点赞 / OK） -->
<section id="gesture" class="card hidden" style="margin-top:12px">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="big">手势舞（精简跟拍）🕺</div>
      <div class="smallmuted"><b>挥手</b>、<b>点赞</b>、<b>OK</b>。包含动态示意与烟花效果。</div>
    </div>
    <div class="row">
      <button class="btn" id="startCamG">开启摄像头</button>
      <button class="btn" id="stopCamG">关闭摄像头</button>
      <button class="btn" id="toggleMirrorG">镜像</button>
      <label class="btn">N帧：<input id="needFramesG" type="range" min="1" max="5" value="2" style="vertical-align:middle"></label>
      <label class="btn">阈值：<input id="thrG" type="range" min="0.35" max="0.90" step="0.01" value="0.55"></label>
    </div>
  </div>

  <div style="margin-top:12px" class="mediaWrap card small">
    <div style="position:relative">
      <video id="camG" autoplay playsinline muted style="width:100%;border-radius:10px;background:#000"></video>
      <div id="refOverlay" style="position:absolute;left:8px;top:8px;opacity:0.92;display:block;border:1px dashed rgba(255,255,255,.6);border-radius:10px;background:rgba(0,0,0,.35);padding:8px">
        <div id="refAnimG" class="animBox">
          <div class="animEmoji">👋</div>
          <div class="animArrow">→←</div>
          <div class="animHint">动态示意</div>
        </div>
      </div>
    </div>
    <div style="position:relative">
      <canvas id="outG" style="width:100%;border-radius:10px;background:#000"></canvas>
      <canvas id="fxG" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none"></canvas>
      <div id="beatOverlay" style="position:absolute;left:50%;top:10px;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:6px 12px;border-radius:9999px;font-weight:700;letter-spacing:.5px;pointer-events:none;white-space:nowrap">—</div>
      <div style="margin-top:8px" class="bar"><div id="frameFillG" style="width:0%"></div></div>
      <div style="margin-top:6px" class="smallmuted">当前识别：
        <span id="predG">—</span>
        置信度：<span id="confG">0.00</span>
      </div>
    </div>
  </div>

  <div style="margin-top:12px" class="row">
    <div class="card" style="flex:1">
      <div class="smallmuted">舞序：</div>
      <select id="seqSelectG"></select>
      <div style="margin-top:8px"><button class="btn" id="playSeqG">开始</button> <button class="btn" id="skipG">跳过</button> <button class="btn" id="resetSeqG">重置</button></div>
    </div>
    <div class="card" id="beatGuide" style="flex:1.6">
      <div class="smallmuted">动作提示：</div>
      <div id="beatNow" class="big" style="font-size:24px;margin-top:4px">—</div>
      <div class="smallmuted" style="margin-top:4px">下一步：<span id="beatNext">—</span></div>
      <div class="smallmuted" style="margin-top:6px">全部动作：</div>
      <div id="beatStrip" class="row" style="gap:6px;flex-wrap:wrap"></div>
    </div>
  </div>
</section>

<div class="footer smallmuted">
  说明：本页面包含“笑话”“古诗接句”“手势舞（仅挥手/点赞/OK）”。笑话和古诗均有内置本地库；若上传外部库，当前会话内将替换内置库（不覆盖文件）。
</div>
</main>

<script>
// =============== 内置笑话库（预装，离线可用） ===============
const JOKES = [
  "老师：为什么迟到？学生：路上遇到选择题，我选了‘绕行’。",
  "小明：我会隐身。老师：那你给我隐一个作业看看。",
  "问：怎么把大象放进冰箱？答：三步——打开、放进去、关上。",
  "问：那长颈鹿呢？答：先把大象请出来。",
  "狮子开动物大会，谁没来？答：长颈鹿，因为在冰箱里。",
  "朋友：你减肥成功了吗？我：成功把称重电池减没了。",
  "老师：地球为什么是圆的？学生：因为方的会卡在宇宙拐角。",
  "妈妈：写完作业了吗？我：写完了‘标题’两个字。",
  "问：什么东西越洗越脏？答：水。",
  "问：什么门永远关不上？答：球门。",
  "老师：用‘一……就……’造句。学生：我一到周末就想写作业以外的事。",
  "问：什么米不能吃？答：秘密。",
  "问：什么瓜不能吃？答：傻瓜。",
  "问：什么布剪不断？答：瀑布。",
  "问：哪种狗不咬人？答：热狗。",
  "问：哪种鱼最会写作业？答：章鱼，手多。",
  "问：什么东西看不见却能装满房间？答：笑声。",
  "问：世界上最小的岛？答：安全岛。",
  "问：什么鞋最贵？答：学（鞋/费）。",
  "问：什么钥匙打不开门？答：音阶 do re mi。"
];

// =============== 内置古诗库（示例，支持外部加载覆盖） ===============
const POEMS_BASE = [
  {author:"李白",title:"静夜思",lines:["床前明月光","疑是地上霜","举头望明月","低头思故乡"]},
  {author:"王之涣",title:"登鹳雀楼",lines:["白日依山尽","黄河入海流","欲穷千里目","更上一层楼"]},
  {author:"孟浩然",title:"春晓",lines:["春眠不觉晓","处处闻啼鸟","夜来风雨声","花落知多少"]},
  {author:"王维",title:"相思",lines:["红豆生南国","春来发几枝","愿君多采撷","此物最相思"]},
  {author:"杜甫",title:"春望",lines:["国破山河在","城春草木深","感时花溅泪","恨别鸟惊心"]},
  {author:"杜牧",title:"清明",lines:["清明时节雨纷纷","路上行人欲断魂","借问酒家何处有","牧童遥指杏花村"]},
  {author:"贺知章",title:"咏柳",lines:["碧玉妆成一树高","万条垂下绿丝绦","不知细叶谁裁出","二月春风似剪刀"]},
  {author:"柳宗元",title:"江雪",lines:["千山鸟飞绝","万径人踪灭","孤舟蓑笠翁","独钓寒江雪"]},
  {author:"王维",title:"鹿柴",lines:["空山不见人","但闻人语响","返景入深林","复照青苔上"]},
  {author:"白居易",title:"赋得古原草送别",lines:["离离原上草","一岁一枯荣","野火烧不尽","春风吹又生"]}
];
let POEMS = POEMS_BASE.slice();

// =============== Tab 切换 ===============
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const key=t.dataset.tab; document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(key).classList.remove('hidden');
}));

// =============== 笑话模块 ===============
const jokeText = document.getElementById('jokeText');
function showJoke(){ if(!JOKES.length){jokeText.textContent='（笑话库为空）';return;} const i=Math.floor(Math.random()*JOKES.length); jokeText.textContent = JOKES[i]; }
document.getElementById('jokeNext').addEventListener('click', showJoke);
document.getElementById('jokeRead').addEventListener('click', ()=>{ const t=jokeText.textContent||''; if(!t) return; try{ const u=new SpeechSynthesisUtterance(t); u.lang='zh-CN'; speechSynthesis.speak(u);}catch(e){} });
document.getElementById('jokeReset').addEventListener('click', ()=>{ showJoke(); alert('已恢复内置笑话库'); });
document.getElementById('jokeFile').addEventListener('change', async (ev)=>{
  const f=ev.target.files[0]; if(!f) return; const txt=await f.text();
  const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const loaded=[];
  for(const L of lines){ try{ const obj=JSON.parse(L); let text=null; for(const k of ['joke','text','content','body','title','prompt','answer']){ if(typeof obj[k]==='string'&&obj[k].trim()){text=obj[k].trim();break;} } if(!text){ if(obj.question&&obj.answer) text=obj.question+' — '+obj.answer; else text=JSON.stringify(obj); } loaded.push(text); }catch{ loaded.push(L); } }
  if(loaded.length){ window.JOKES = loaded; showJoke(); alert('已加载外部笑话库（'+loaded.length+' 条）'); } else { alert('未解析到有效笑话'); }
});

// 初始显示一个笑话
showJoke();

// =============== 古诗接句 ===============
let currentPoem=null,currentLineIdx=0; const poemCountEl=document.getElementById('poemCount'); poemCountEl.textContent=POEMS.length;
const poemShown=document.getElementById('poemShown'), poemMeta=document.getElementById('poemMeta'), poemAnswer=document.getElementById('poemAnswer');
function normalize(s){return (s||'').replace(/\s+/g,'').replace(/[，。,.!！？；;：:、【】\[\]（）()“”\"'\-——]/g,'').trim();}
function pickRandomPoem(){ if(!POEMS.length){ alert('古诗库为空'); return; } const i=Math.floor(Math.random()*POEMS.length); currentPoem=POEMS[i]; currentLineIdx=Math.floor(Math.random()*currentPoem.lines.length); poemShown.textContent=currentPoem.lines[currentLineIdx]; poemMeta.textContent=`${currentPoem.author} · ${currentPoem.title}`; poemAnswer.classList.add('hidden'); poemAnswer.textContent=''; const rv=document.getElementById('poemReveal'); if(rv) rv.classList.add('hidden'); document.getElementById('poemDirection').value='prev'; document.getElementById('poemAnswerInput').value=''; document.getElementById('progress').style.width='0%'; }

document.getElementById('poemChallenge').addEventListener('click', pickRandomPoem);

document.getElementById('poemReveal').addEventListener('click', ()=>{ if(!currentPoem) return; const idx=currentLineIdx, lines=currentPoem.lines; const prev=(idx>0)?lines[idx-1]:'（无上一句）'; const next=(idx<lines.length-1)?lines[idx+1]:'（无下一句）'; poemAnswer.textContent='上一句：'+prev+'\n下一句：'+next; poemAnswer.classList.remove('hidden'); });

document.getElementById('poemSubmit').addEventListener('click', ()=>{
  if(!currentPoem){ alert('请先点击“随机出题”'); return; }
  const guess=document.getElementById('poemAnswerInput').value.trim();
  const direction=document.getElementById('poemDirection').value||'prev';
  const lines=currentPoem.lines, idx=currentLineIdx; const prev=(idx>0)?lines[idx-1]:null, next=(idx<lines.length-1)?lines[idx+1]:null; const ok = direction==='prev' ? (prev&&normalize(prev)===normalize(guess)) : (next&&normalize(next)===normalize(guess));
  const rv=document.getElementById('poemReveal'); if(!ok){ rv.classList.remove('hidden'); document.getElementById('progress').style.width='30%'; alert('❌ 不正确，可点击“查看答案”'); } else { rv.classList.add('hidden'); document.getElementById('progress').style.width='100%'; alert('✅ 回答正确！'); }
});

// 外部加载古诗库 / 重置
(function(){
  const file=document.getElementById('poemFile'); if(file){ file.addEventListener('change', async (ev)=>{
    try{ const f=ev.target.files&&ev.target.files[0]; if(!f) return; const raw=await f.text(); let items=[];
      const lines=raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      for(const L of lines){ let rec=null; try{ rec=JSON.parse(L); }catch(_){}}
      for(const L of lines){ let rec=null; try{ rec=JSON.parse(L); }catch(_){ }
        if(!rec){ const t=L.split('\t'); if(t.length>=3){ rec={author:t[0], title:t[1], lines:t[2].split('|').map(x=>x.trim()).filter(Boolean)}; } }
        if(rec && Array.isArray(rec.lines) && rec.lines.length>=2){ items.push({author:String(rec.author||'佚名'), title:String(rec.title||'无题'), lines:rec.lines.map(x=>String(x))}); }
      }
      if(!items.length){ try{ const arr=JSON.parse(raw); if(Array.isArray(arr)){ for(const rec of arr){ if(rec && Array.isArray(rec.lines) && rec.lines.length>=2){ items.push({author:String(rec.author||'佚名'), title:String(rec.title||'无题'), lines:rec.lines.map(x=>String(x))}); } } } }catch(_){ }
      }
      if(!items.length){ alert('未解析到有效古诗数据。支持：\n1) JSONL 每行 {author,title,lines:[...]}\n2) 单个 JSON 数组\n3) author\\ttitle\\tline1|line2|...'); return; }
      POEMS = items; poemCountEl.textContent=POEMS.length; pickRandomPoem(); alert('已加载古诗库：'+POEMS.length+' 首');
    }catch(e){ alert('加载古诗库失败：'+e.message); }
  }); }
  const reset=document.getElementById('poemReset'); if(reset){ reset.addEventListener('click',()=>{ POEMS = POEMS_BASE.slice(); poemCountEl.textContent=POEMS.length; pickRandomPoem(); alert('已重置为内置古诗库'); }); }
})();

// 初始出题一次
pickRandomPoem();

// =============== 全局错误兜底（便于排查“未显示”） ===============
(function(){
  const box=document.createElement('div'); box.id='globalErr'; box.style.cssText='position:fixed;left:8px;bottom:8px;background:#fff3f3;border:1px solid #ffd6d6;color:#8a1616;padding:6px 8px;border-radius:8px;font-size:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);display:none;z-index:9999;max-width:70vw;white-space:pre-wrap;'; document.body.appendChild(box);
  const show=(m)=>{ box.textContent='脚本提示：'+m; box.style.display='block'; };
  window.addEventListener('error',e=>{ show(e.message||String(e.error||e)); });
  window.addEventListener('unhandledrejection',e=>{ show('Promise 失败：'+(e.reason && e.reason.message || String(e.reason))); });
})();
</script>
<!-- 手势舞（精简）脚本，只识别：挥手 / 点赞 / OK -->
<script>
// 预设舞序
const seqsG=[
  {name:'基础连招',beats:['挥手(右)','挥手(左)','点赞','OK']},
  {name:'三连',beats:['点赞','OK','挥手(右)']}
];
// 注入选项
(function(){ const sel = document.getElementById('seqSelectG'); if(sel){ sel.innerHTML = seqsG.map((s,i)=>`<option value="${i}">${s.name}</option>`).join(''); }})();

// 相机 & Hands
let camStreamG=null, cameraG=null, handsG=null, landmarksG=[], handednessG=[];
const videoG=document.getElementById('camG'), outG=document.getElementById('outG');
const ctxG= outG? outG.getContext('2d') : null;
const fxG=document.getElementById('fxG'), fxCtx= fxG? fxG.getContext('2d'):null;
let fxParts=[], fxRaf=0, lastRoiG=null; let seqIdxG=0, pointsG=0, hitsG=0, gapG=0; const stateG={last:{},velx:{},conf:0,lastLabel:''};

// 基础工具
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);} 
function getROIs(ptsArr,w,h){ const rois=[]; const pad=60; for(const pts of ptsArr){ if(!pts||pts.length<21) continue; let minx=1,miny=1,maxx=0,maxy=0; for(const p of pts){ if(p.x<minx)minx=p.x; if(p.x>maxx)maxx=p.x; if(p.y<miny)miny=p.y; if(p.y>maxy)maxy=p.y; } let x=minx*w-pad,y=miny*h-pad,rw=(maxx-minx)*w+pad*2,rh=(maxy-miny)*h+pad*2; x=Math.max(0,x); y=Math.max(0,y); rw=Math.min(w-x,rw); rh=Math.min(h-y,rh); rois.push({x,y,rw,rh}); } return rois; }

function renderBG(ptsArr){ if(!outG||!ctxG||!videoG) return; outG.width=videoG.videoWidth||640; outG.height=videoG.videoHeight||480; const rois=getROIs(ptsArr,outG.width,outG.height); const orig=document.createElement('canvas'); orig.width=outG.width; orig.height=outG.height; const octx=orig.getContext('2d'); octx.drawImage(videoG,0,0,orig.width,orig.height); ctxG.drawImage(orig,0,0,orig.width,orig.height); if(rois.length){ ctxG.save(); ctxG.beginPath(); for(const r of rois) ctxG.rect(r.x,r.y,r.rw,r.rh); ctxG.clip(); ctxG.drawImage(orig,0,0,orig.width,orig.height); ctxG.restore(); } if(rois.length){ let rx=rois[0].x, ry=rois[0].y, rw=rois[0].rw, rh=rois[0].rh; for(let i=1;i<rois.length;i++){ const r=rois[i]; const nx=Math.min(rx,r.x), ny=Math.min(ry,r.y), mx=Math.max(rx+rw,r.x+r.rw), my=Math.max(ry+rh,r.y+r.rh); rx=nx;ry=ny;rw=mx-rx;rh=my-ry; } lastRoiG={x:rx,y:ry,rw:rw,rh:rh}; } else { lastRoiG=null; }
  if(landmarksG.length){ for(let i=0;i<landmarksG.length;i++){ drawConnectors(ctxG,landmarksG[i],HAND_CONNECTIONS,{color:'#ffffff',lineWidth:5}); drawConnectors(ctxG,landmarksG[i],HAND_CONNECTIONS,{color:'#0ea5e9',lineWidth:2}); drawLandmarks(ctxG,landmarksG[i],{color:'#ffffff',lineWidth:2,radius:3}); drawLandmarks(ctxG,landmarksG[i],{color:'#0ea5e9',lineWidth:1,radius:2}); } }
  return rois; }

function onResultsG(res){ const ptsArr = res.multiHandLandmarks||[]; landmarksG=ptsArr; handednessG=(res.multiHandedness||[]).map(h=>h.label); const rois=renderBG(ptsArr); if(fxG && (fxG.width!==outG.width || fxG.height!==outG.height)){ fxG.width=outG.width; fxG.height=outG.height; } classifyG(); }

function extractF(){ const F={L:null,R:null}; for(let i=0;i<landmarksG.length;i++){ const label = handednessG[i] || 'Right'; const pts   = landmarksG[i]; if(!pts||pts.length<21) continue; const wrist=pts[0], thumbMcp=pts[2], thumbTip=pts[4], indexMcp=pts[5], indexTip=pts[8], middleMcp=pts[9], middleTip=pts[12], ringMcp=pts[13], ringTip=pts[16], pinkyMcp=pts[17], pinkyTip=pts[20]; const palmW = dist(indexMcp,pinkyMcp)+1e-6; const palmH = dist(wrist,middleTip)+1e-6; const spread    = dist(thumbTip,pinkyTip)/palmW; const extThumb  = dist(thumbTip,thumbMcp)/palmW; const extIndex  = dist(indexTip,indexMcp)/palmH; const extMiddle = dist(middleTip,middleMcp)/palmH; const extRing   = dist(ringTip,ringMcp)/palmH; const extPinky  = dist(pinkyTip,pinkyMcp)/palmH; const k=(label==='Left')?'L':'R'; const last=stateG.last[k]; let velx=0; if(last) velx=Math.abs(wrist.x-last.x); stateG.last[k]={x:wrist.x,y:wrist.y}; stateG.velx[k]=(stateG.velx[k]||0)*0.8+velx*0.2; F[k]={spread,extThumb,extIndex,extMiddle,extRing,extPinky,wrist,indexMcp,thumbTip,indexTip,pinkyTip,palmW,palmH,velx:stateG.velx[k]}; } return F; }

function classifyG(){
  const F=extractF();
  const isThumbUp=(H)=> H && (H.extThumb>0.82 && H.extIndex<0.70 && H.extMiddle<0.70 && H.extRing<0.70 && H.extPinky<0.70) && ((H.thumbTip.y < H.indexMcp.y - 0.01) || (Math.abs(H.thumbTip.y - H.indexMcp.y) < 0.035 && Math.abs(H.thumbTip.x - H.wrist.x) > 0.06));
  const okRatio=(H)=> H ? (dist(H.thumbTip,H.indexTip)/Math.max(1e-6,H.palmW)) : 1;
  const isOK=(H)=> H && (okRatio(H) < 0.48) && (H.extMiddle>0.55 && H.extRing>0.55 && H.extPinky>0.55);

  const cands=[];
  [['L',F.L],['R',F.R]].forEach(([side,H])=>{
    if(!H) return;
    if(H.velx>0.012) cands.push({label: side==='L'?'挥手(左)':'挥手(右)', conf: Math.min(1,(H.velx-0.012)/0.02)});
    if(isOK(H)) cands.push({label:'OK', conf:0.90});
    if(isThumbUp(H)) cands.push({label:'点赞', conf:0.88});
  });

  let best={label:'未知',conf:0};
  for(const c of cands){ if(c.conf>best.conf) best=c; }

  const thr=parseFloat(document.getElementById('thrG').value)||0.55;
  stateG.conf = stateG.conf*0.6 + best.conf*0.4;
  document.getElementById('predG').textContent = best.label;
  document.getElementById('confG').textContent=(stateG.conf||0).toFixed(2);

  const needN=parseInt(document.getElementById('needFramesG').value,10)||2;
  const cur=getCurSeq();
  const needLabel=cur && cur.beats[seqIdxG];
  const matched=(needLabel && best.label===needLabel && (stateG.conf||0)>=thr);
  if(matched){ hitsG+=1; gapG=0; } else { if(hitsG>0 && gapG<1){ gapG+=1; } else { hitsG=0; gapG=0; } }
  document.getElementById('frameFillG').style.width=Math.min(100,Math.round(100*hitsG/needN))+'%';
  if(hitsG>=needN){ hitsG=0; gapG=0; pointsG+=10; celebrateG('pass'); nextStepG(); }
  renderBeatGuide();
}

function getCurSeq(){ const sel=document.getElementById('seqSelectG'); const idx=parseInt(sel?.value||'0',10)||0; return seqsG[idx]||{beats:[]}; }
function nextStepG(){ const cur=getCurSeq(); seqIdxG+=1; if(seqIdxG>=cur.beats.length){ celebrateG('complete'); alert('完成舞序！得分:'+pointsG); seqIdxG=0; } renderBeatGuide(true); }

function dynamicSpec(name){ name=String(name||''); if(name.includes('挥手')) return {emoji:'👋', cls:'anim-waveX', hint:'挥手', arrow:'→←'}; if(name.includes('点赞')) return {emoji:'👍', cls:'anim-bounce', hint:'点赞', arrow:'↑'}; if(/^OK|ＯＫ|ok/i.test(name)) return {emoji:'👌', cls:'anim-pulse', hint:'OK', arrow:'·'}; return {emoji:'✋', cls:'anim-pulse', hint:name||'手势', arrow:'·'}; }
function setRefDynamic(name){ const host=document.getElementById('refAnimG'); if(!host) return; const spec=dynamicSpec(name); host.innerHTML = `<div class="animEmoji ${spec.cls}">${spec.emoji}</div><div class="animArrow">${spec.arrow}</div><div class="animHint">${name} · ${spec.hint}</div>`; }

function renderBeatGuide(forceSpeak=false){ const cur=getCurSeq(); const now=cur.beats[seqIdxG]||'—'; const next=cur.beats[seqIdxG+1]||'完成'; const overlay=document.getElementById('beatOverlay'); if(overlay){ overlay.textContent='请做：'+now; } const nowEl=document.getElementById('beatNow'); if(nowEl) nowEl.textContent=now; const nextEl=document.getElementById('beatNext'); if(nextEl) nextEl.textContent=next; const strip=document.getElementById('beatStrip'); if(strip){ strip.innerHTML = cur.beats.map((b,i)=>{ const cls=i<seqIdxG?'badge done':(i===seqIdxG?'badge active':'badge'); return `<span class="${cls}">${i+1}. ${b}${i<seqIdxG?' ✓':''}</span>`; }).join(''); } setRefDynamic(now); }

// 简易烟花
const FX_PALETTE=['#ffca3a','#8ac926','#1982c4','#6a4c93','#ff595e','#ffffff'];
function spawnBurst(x,y,count){ for(let i=0;i<count;i++){ const ang=Math.random()*Math.PI*2; const sp=(Math.random()*2.5+1.5)*(Math.random()<0.3?2:1); fxParts.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp - Math.random()*0.5,life:60+Math.random()*40,color:FX_PALETTE[(Math.random()*FX_PALETTE.length)|0],size:2+Math.random()*2,g:0.035}); } }
function runFx(){ if(fxRaf) return; const step=()=>{ fxRaf=requestAnimationFrame(step); if(!fxG) return; fxCtx.clearRect(0,0,fxG.width,fxG.height); fxCtx.globalCompositeOperation='lighter'; for(let i=0;i<fxParts.length;i++){ const p=fxParts[i]; p.vx*=0.985; p.vy*=0.985; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.life-=1; if(p.life<=0){ fxParts.splice(i,1); i--; continue; } fxCtx.beginPath(); fxCtx.arc(p.x,p.y,p.size,0,Math.PI*2); fxCtx.fillStyle=p.color; fxCtx.fill(); } fxCtx.globalCompositeOperation='source-over'; if(fxParts.length===0){ cancelAnimationFrame(fxRaf); fxRaf=0; fxCtx.clearRect(0,0,fxG.width,fxG.height);} }; step(); }
function celebrateG(kind='pass'){ if(!fxG) return; const cx= lastRoiG? (lastRoiG.x+lastRoiG.rw/2) : (fxG.width/2); const cy= lastRoiG? (lastRoiG.y+Math.max(0,lastRoiG.rh*0.2)) : (fxG.height*0.35); const bursts = (kind==='complete')?6:3; for(let i=0;i<bursts;i++){ const ang=Math.random()*Math.PI*2; const r=(kind==='complete'? (Math.random()*120+40) : (Math.random()*60+30)); spawnBurst(cx+Math.cos(ang)*r, cy+Math.sin(ang)*r, kind==='complete'?90:60); } runFx(); }

// 相机开关
async function ensureMediaPipe(){ if(window.Hands && window.Camera) return true; const add=(src)=>new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(new Error('加载失败 '+src)); document.head.appendChild(s); }); await add('https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js'); await add('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js'); await add('https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js'); return true; }

document.getElementById('startCamG')?.addEventListener('click', async ()=>{
  try{
    if(!navigator.mediaDevices){ alert('此环境不支持摄像头 API'); return; }
    camStreamG = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}, audio:false});
    videoG.srcObject=camStreamG; await videoG.play();
    await ensureMediaPipe();
    handsG = new Hands({locateFile:(f)=> `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`});
    handsG.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
    handsG.onResults(onResultsG);
    cameraG = new Camera(videoG,{onFrame:async()=>{ await handsG.send({image:videoG}); },width:640,height:480}); cameraG.start();
    renderBeatGuide(true);
    if(location.protocol!=='https:' && location.hostname!=='localhost' && location.hostname!=='127.0.0.1'){
      setTimeout(()=>alert('提示：多数浏览器在 file:// 或非安全上下文无法启用摄像头。建议使用 https 或本地小服务器。'), 1000);
    }
  }catch(e){ alert('无法开启摄像头：'+e.message); }
});

document.getElementById('stopCamG')?.addEventListener('click', ()=>{ if(camStreamG){camStreamG.getTracks().forEach(t=>t.stop()); camStreamG=null;} if(cameraG){cameraG.stop();cameraG=null;} });

document.getElementById('playSeqG')?.addEventListener('click',()=>{ seqIdxG=0; renderBeatGuide(true); });
document.getElementById('skipG')?.addEventListener('click',()=>{ nextStepG(); });
document.getElementById('resetSeqG')?.addEventListener('click',()=>{ seqIdxG=0; pointsG=0; hitsG=0; gapG=0; renderBeatGuide(true); });
</script>
<script>
let mirrorOn=false;
(() => {
  const btn=document.getElementById('toggleMirrorG');
  if(!btn) return;
  const apply=()=>{
    [document.getElementById('camG'),document.getElementById('outG'),document.getElementById('fxG')]
      .forEach(el=> el && el.classList.toggle('mirror', mirrorOn));
    btn.classList.toggle('toggled', mirrorOn);
    btn.textContent = mirrorOn ? '取消镜像' : '镜像';
  };
  btn.addEventListener('click',()=>{ mirrorOn=!mirrorOn; apply(); });
})();
</script>
<!-- 依赖：若上面 ensureMediaPipe 已加载，这里可省；保守起见保留 -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>

</body>
</html>
