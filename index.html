<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è¯¾å ‚å¨±ä¹ç«™ Â· ç¬‘è¯ / å¤è¯—æ¥å¥ / æ‰‹åŠ¿èˆï¼ˆåŠ¨æ€ç¤ºæ„+çƒŸèŠ±ï¼‰</title>
<style>
:root{--bg:#f6fbff;--accent:#2bb0ed;--muted:#5b6b7b}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei";background:linear-gradient(180deg,#fff,var(--bg));color:#0e1b2a}
.header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid #eef4fb;background:#fff;position:sticky;top:0;z-index:10}
.logo{font-weight:700;color:var(--accent)}
.tabs{display:flex;gap:8px;margin-left:12px}
.tab{padding:8px 12px;border-radius:10px;cursor:pointer;background:#f7fbff;border:1px solid #e6f0fb}
.tab.active{background:linear-gradient(90deg,#bfefff,#e8f6ff);box-shadow:0 6px 18px rgba(43,176,237,.08)}
.container{max-width:1100px;margin:16px auto;padding:8px}
.card{background:#fff;border-radius:12px;padding:12px;border:1px solid #e9f2fb;box-shadow:0 6px 18px rgba(10,30,60,.03)}
.card.small{padding:8px;font-size:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;cursor:pointer}
.big{font-size:18px;font-weight:600}
.smallmuted{color:var(--muted);font-size:13px}
.hidden{display:none}
.input{padding:8px;border-radius:8px;border:1px solid #e6eef6}
.label{font-size:13px;color:#5b6b7b}
.footer{margin-top:12px;color:#6e84a3;font-size:13px}
.bar{height:10px;background:#eef4ff;border-radius:999px;overflow:hidden;border:1px solid #e6eef6}
.bar>div{height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%}
.mediaWrap{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.mediaWrap{grid-template-columns:1fr}}
.badge{display:inline-block;padding:4px 8px;border-radius:9999px;border:1px solid #e6eef6}
.badge.active{background:linear-gradient(90deg,#bfefff,#e8f6ff);font-weight:700}
.badge.done{background:#eef7ff;opacity:.9}
/* â€”â€” åŠ¨æ€ç¤ºæ„å›¾ï¼ˆemoji + CSS åŠ¨ç”»ï¼‰ â€”â€” */
.animBox{width:190px;display:flex;flex-direction:column;align-items:center;gap:6px}
.animEmoji{font-size:96px;line-height:1;filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}
.animHint{font-size:12px;color:#fff;opacity:.95}
.animArrow{font-size:22px;color:#bfe1ff;margin-top:-4px}
@keyframes waveX{0%,100%{transform:translateX(-12%) rotate(-10deg)}50%{transform:translateX(12%) rotate(12deg)}}
@keyframes sway{0%,100%{transform:rotate(-6deg)}50%{transform:rotate(6deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.18)}}
@keyframes heartbeat{0%,70%,100%{transform:scale(1)}15%{transform:scale(1.25)}40%{transform:scale(1.12)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10%)}}
@keyframes updown{0%,100%{transform:translateY(6%)}50%{transform:translateY(-6%)}}
.anim-waveX{animation:waveX 1.1s ease-in-out infinite}
.anim-sway{animation:sway 1.1s ease-in-out infinite}
.anim-pulse{animation:pulse .9s ease-in-out infinite}
.anim-heart{animation:heartbeat 1.3s ease-in-out infinite}
.anim-bounce{animation:bounce .9s ease-in-out infinite}
.anim-updown{animation:updown 1.1s ease-in-out infinite}
</style>
</head>
<body>
<div class="header">
  <div class="logo">è¯¾å ‚å¨±ä¹ç«™ Â· ç¬‘è¯ / å¤è¯—æ¥å¥ / æ‰‹åŠ¿èˆ</div>
  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="jokes">ç¬‘è¯</div>
    <div class="tab" data-tab="poems">å¤è¯—æ¥å¥</div>
    <div class="tab" data-tab="gesture">æ‰‹åŠ¿èˆ</div>
  </div>
  <div style="margin-left:auto" class="smallmuted">çº¯æœ¬åœ°ç¬‘è¯&å¤è¯— Â· å¯é€‰æ‰‹åŠ¿èˆï¼ˆéœ€æ‘„åƒå¤´ï¼‰</div>
</div>

<main class="container">

<!-- ç¬‘è¯ -->
<section id="jokes" class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="big">ç¬‘è¯æ—¶é—´ ğŸ˜‚</div>
      <div class="smallmuted">å·²å†…ç½®ç¬‘è¯åº“ï¼Œæ”¯æŒä¸Šä¼  JSONL/TXT æ›¿æ¢ã€‚</div>
    </div>
    <div class="row">
      <button class="btn" id="jokeNext">æ¢ä¸€ä¸ª</button>
      <button class="btn" id="jokeRead">æœ—è¯»</button>
      <label class="btn">åŠ è½½å¤–éƒ¨åº“<input id="jokeFile" type="file" accept=".jsonl,.txt" style="display:none"></label>
      <button class="btn" id="jokeReset">é‡ç½®å†…ç½®åº“</button>
    </div>
  </div>
  <div style="margin-top:12px" id="jokeText" class="big">åŠ è½½ä¸­â€¦</div>
</section>

<!-- å¤è¯—æ¥å¥ï¼ˆå…ˆé€‰â€œä¸Šä¸€å¥/ä¸‹ä¸€å¥â€ï¼Œå†ä½œç­”ï¼›ç­”é”™æ‰å¯â€œæŸ¥çœ‹ç­”æ¡ˆâ€ï¼‰ -->
<section id="poems" class="card hidden" style="margin-top:12px">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="big">å¤è¯—æ¥å¥ ğŸ“</div>
      <div class="smallmuted">å…ˆé€‰æ‹©â€œä¸Šä¸€å¥/ä¸‹ä¸€å¥â€ï¼Œå†è¾“å…¥å¯¹åº”è¯—å¥ã€‚ç­”é”™æ‰ä¼šå‡ºç°â€œæŸ¥çœ‹ç­”æ¡ˆâ€ã€‚</div>
    </div>
    <div class="row">
      <button class="btn" id="poemChallenge">éšæœºå‡ºé¢˜</button>
      <span class="smallmuted">å½“å‰åº“ï¼š<b id="poemCount">0</b> é¦–</span>
      <label class="btn">åŠ è½½å¤è¯—åº“<input id="poemFile" type="file" accept=".jsonl,.json,.txt" style="display:none"></label>
      <button class="btn" id="poemReset">é‡ç½®å¤è¯—åº“</button>
    </div>
  </div>

  <div style="margin-top:12px" class="card small">
    <div class="smallmuted">é¢˜ç›®ï¼ˆéšæœºæŠ½ä¸€è¡Œï¼‰ï¼š</div>
    <div id="poemShown" class="big">â€”</div>
    <div class="smallmuted">ä½œè€… / é¢˜ç›®ï¼š<span id="poemMeta">â€”</span></div>

    <div class="row" style="margin-top:8px">
      <label class="label">æˆ‘è¦å›ç­”ï¼š</label>
      <select id="poemDirection" class="input">
        <option value="prev">ä¸Šä¸€å¥</option>
        <option value="next">ä¸‹ä¸€å¥</option>
      </select>
      <span class="smallmuted">ï¼ˆå…ˆé€‰æ–¹å‘ï¼Œå†ä½œç­”ï¼‰</span>
    </div>

    <div style="margin-top:8px">
      <input id="poemAnswerInput" class="input" style="min-width:260px" placeholder="è¾“å…¥å¯¹åº”è¯—å¥ï¼ˆä¸å¿…åŠ æ ‡ç‚¹ï¼‰"/>
      <button class="btn" id="poemSubmit">æäº¤</button>
      <button class="btn hidden" id="poemReveal">æŸ¥çœ‹ç­”æ¡ˆ</button>
      <div class="bar" style="margin-top:8px;width:280px"><div id="progress" style="width:0%"></div></div>
    </div>
    <pre id="poemAnswer" class="hidden" style="margin-top:8px;padding:8px"></pre>
  </div>
</section>

<!-- æ‰‹åŠ¿èˆï¼ˆè·Ÿæ‹ï¼‰ -->
<section id="gesture" class="card hidden" style="margin-top:12px">
  <div class="row" style="justify-content:space-between">
    <div><div class="big">æ‰‹åŠ¿èˆï¼ˆè·Ÿæ‹ Â· å­¦ç”Ÿæ¨¡å¼ï¼‰ğŸ•º</div><div class="smallmuted">æ¯ä¸€æ‹éœ€è¦è·Ÿçš„å†…å®¹ï¼šç”»é¢é¡¶éƒ¨å åŠ æç¤º + å³ä¾§æ­¥éª¤å¼•å¯¼ + è¯­éŸ³æ’­æŠ¥ï¼ˆå¯é€‰ï¼‰+ <b>åŠ¨æ€ç¤ºæ„å›¾</b> + <b>çƒŸèŠ±åº†ç¥</b></div></div>
    <div class="row">
      <button class="btn" id="startCamG">å¼€å¯æ‘„åƒå¤´</button>
      <button class="btn" id="stopCamG">å…³é—­æ‘„åƒå¤´</button>
      <label class="btn">é¢„è®¾ï¼š
        <select id="presetG">
          <option value="student">å­¦ç”Ÿ</option>
          <option value="demo">æ¼”ç¤º</option>
          <option value="precise">ç²¾ç¡®</option>
        </select>
      </label>
      <label class="btn">æ¨¡å‹å¤æ‚åº¦ï¼š
        <select id="modelComplexityG"><option>0</option><option selected>1</option><option>2</option></select>
      </label>
      <label class="btn">æ‰‹æ•°é™åˆ¶ï¼š
        <select id="maxHandsG"><option selected>1</option><option>2</option></select>
      </label>
      <label class="btn">åº“æ¥æºï¼š
        <select id="mpSourceG"><option value="cdn">CDN</option><option value="local">æœ¬åœ°</option></select>
      </label>
      <label class="btn">Nå¸§ï¼š<input id="needFramesG" type="range" min="1" max="5" value="2" style="vertical-align:middle"></label>
      <label class="btn">é˜ˆå€¼ï¼š<input id="thrG" type="range" min="0.35" max="0.90" step="0.01" value="0.55"></label>
    </div>
  </div>

  <div style="margin-top:12px" class="mediaWrap card small">
    <div style="position:relative">
      <video id="camG" autoplay playsinline muted style="width:100%;border-radius:10px;background:#000"></video>
      <div id="refOverlay" style="position:absolute;left:8px;top:8px;opacity:0.92;display:block;border:1px dashed rgba(255,255,255,.6);border-radius:10px;background:rgba(0,0,0,.35);padding:8px">
        <div id="refAnimG" class="animBox">
          <div class="animEmoji">ğŸ–</div>
          <div class="animArrow">â€”</div>
          <div class="animHint">åŠ¨æ€ç¤ºæ„</div>
        </div>
      </div>
    </div>
    <div style="position:relative">
      <canvas id="outG" style="width:100%;border-radius:10px;background:#000"></canvas>
      <canvas id="fxG" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none"></canvas>
      <div id="beatOverlay" style="position:absolute;left:50%;top:10px;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:6px 12px;border-radius:9999px;font-weight:700;letter-spacing:.5px;pointer-events:none;white-space:nowrap">â€”</div>
      <div style="margin-top:8px" class="bar"><div id="frameFillG" style="width:0%"></div></div>
      <div style="margin-top:6px" class="smallmuted">å½“å‰è¯†åˆ«ï¼š
        <span id="predG">â€”</span>
        ç½®ä¿¡åº¦ï¼š<span id="confG">0.00</span>
      </div>
    </div>
  </div>

  <div style="margin-top:12px" class="row">
    <div class="card" style="flex:1">
      <div class="smallmuted">èˆåºï¼š</div>
      <select id="seqSelectG"></select>
      <div style="margin-top:8px"><button class="btn" id="playSeqG">å¼€å§‹</button> <button class="btn" id="skipG">è·³è¿‡</button> <button class="btn" id="resetSeqG">é‡ç½®</button></div>
    </div>
    <div class="card" id="beatGuide" style="flex:1.6">
      <div class="smallmuted">åŠ¨ä½œæç¤ºï¼š</div>
      <div id="beatNow" class="big" style="font-size:24px;margin-top:4px">â€”</div>
      <div class="smallmuted" style="margin-top:4px">ä¸‹ä¸€æ­¥ï¼š<span id="beatNext">â€”</span></div>
      <div class="smallmuted" style="margin-top:6px">å…¨éƒ¨åŠ¨ä½œï¼š</div>
      <div id="beatStrip" class="row" style="gap:6px;flex-wrap:wrap"></div>
    </div>
    <div class="card" style="flex:1">
      <div class="smallmuted">è®¾ç½®ï¼š</div>
      <label class="label">èƒŒæ™¯è™šåŒ–ï¼š<input type="checkbox" id="blurBgG" checked></label><br/>
      <label class="label">èƒŒæ™¯å˜æš—ï¼š<input type="checkbox" id="dimBgG" checked></label><br/>
      <label class="label">æ˜¾ç¤ºèšå…‰ç¯æ¡†ï¼š<input type="checkbox" id="showROIG" checked></label><br/>
      <label class="label">ç¤ºæ„æµ®å±‚ï¼š<input type="checkbox" id="showRefG" checked></label>
      <label class="label" style="margin-left:6px">è·Ÿæ‹æµ®å±‚ï¼š<input type="checkbox" id="followRefG"></label><br/>
      <label class="label">ç”»é¢å åŠ æç¤ºï¼š<input type="checkbox" id="overlayBeatG" checked></label><br/>
      <label class="label">è¯­éŸ³æ’­æŠ¥æç¤ºï¼š<input type="checkbox" id="speakBeatG"></label>
    </div>
  </div>

  <div class="card small" style="margin-top:12px">
    <div class="big">æ‰‹åŠ¿æ¨¡å—è‡ªæ£€ ğŸ› ï¸</div>
    <div class="smallmuted">å¿«é€Ÿå®šä½â€œæ— æ³•åŠ è½½â€çš„åŸå› ï¼ˆæ‘„åƒå¤´æƒé™ / HTTPS / MediaPipe æ¥æºï¼‰ã€‚</div>
    <div id="diagPanelG" class="smallmuted" style="margin-top:8px;white-space:pre-line"></div>
    <div style="margin-top:8px" class="row">
      <button class="btn" id="btnDiagG">ä¸€é”®è‡ªæ£€</button>
      <button class="btn" id="btnDemoG">æ— æ‘„åƒå¤´æ¼”ç¤ºæ¨¡å¼</button>
    </div>
  </div>
</section>

<div class="footer smallmuted">
  è¯´æ˜ï¼šç¬‘è¯/å¤è¯—å†…ç½®æœ¬åœ°åº“ï¼›æ‰‹åŠ¿èˆéœ€æ‘„åƒå¤´ã€‚è‹¥ä½¿ç”¨æœ¬åœ°ç¦»çº¿ MediaPipeï¼Œè¯·å°† hands.js / camera_utils.js / drawing_utils.js ç½®äº ./mediapipe/ å¹¶åœ¨â€œåº“æ¥æºâ€é€‰æ‹©â€œæœ¬åœ°â€ã€‚
</div>
</main>

<script>
// =============== å†…ç½®ç¬‘è¯åº“ï¼ˆé¢„è£…ï¼Œç¦»çº¿å¯ç”¨ï¼‰ ===============
const JOKES = [
  "è€å¸ˆï¼šä¸ºä»€ä¹ˆè¿Ÿåˆ°ï¼Ÿå­¦ç”Ÿï¼šè·¯ä¸Šé‡åˆ°é€‰æ‹©é¢˜ï¼Œæˆ‘é€‰äº†â€˜ç»•è¡Œâ€™ã€‚",
  "å°æ˜ï¼šæˆ‘ä¼šéšèº«ã€‚è€å¸ˆï¼šé‚£ä½ ç»™æˆ‘éšä¸€ä¸ªä½œä¸šçœ‹çœ‹ã€‚",
  "é—®ï¼šæ€ä¹ˆæŠŠå¤§è±¡æ”¾è¿›å†°ç®±ï¼Ÿç­”ï¼šä¸‰æ­¥â€”â€”æ‰“å¼€ã€æ”¾è¿›å»ã€å…³ä¸Šã€‚",
  "é—®ï¼šé‚£é•¿é¢ˆé¹¿å‘¢ï¼Ÿç­”ï¼šå…ˆæŠŠå¤§è±¡è¯·å‡ºæ¥ã€‚",
  "ç‹®å­å¼€åŠ¨ç‰©å¤§ä¼šï¼Œè°æ²¡æ¥ï¼Ÿç­”ï¼šé•¿é¢ˆé¹¿ï¼Œå› ä¸ºåœ¨å†°ç®±é‡Œã€‚",
  "æœ‹å‹ï¼šä½ å‡è‚¥æˆåŠŸäº†å—ï¼Ÿæˆ‘ï¼šæˆåŠŸæŠŠç§°é‡ç”µæ± å‡æ²¡äº†ã€‚",
  "è€å¸ˆï¼šåœ°çƒä¸ºä»€ä¹ˆæ˜¯åœ†çš„ï¼Ÿå­¦ç”Ÿï¼šå› ä¸ºæ–¹çš„ä¼šå¡åœ¨å®‡å®™æ‹è§’ã€‚",
  "å¦ˆå¦ˆï¼šå†™å®Œä½œä¸šäº†å—ï¼Ÿæˆ‘ï¼šå†™å®Œäº†â€˜æ ‡é¢˜â€™ä¸¤ä¸ªå­—ã€‚",
  "é—®ï¼šä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿç­”ï¼šæ°´ã€‚",
  "é—®ï¼šä»€ä¹ˆé—¨æ°¸è¿œå…³ä¸ä¸Šï¼Ÿç­”ï¼šçƒé—¨ã€‚",
  "è€å¸ˆï¼šç”¨â€˜ä¸€â€¦â€¦å°±â€¦â€¦â€™é€ å¥ã€‚å­¦ç”Ÿï¼šæˆ‘ä¸€åˆ°å‘¨æœ«å°±æƒ³å†™ä½œä¸šä»¥å¤–çš„äº‹ã€‚",
  "é—®ï¼šä»€ä¹ˆç±³ä¸èƒ½åƒï¼Ÿç­”ï¼šç§˜å¯†ã€‚",
  "é—®ï¼šä»€ä¹ˆç“œä¸èƒ½åƒï¼Ÿç­”ï¼šå‚»ç“œã€‚",
  "é—®ï¼šä»€ä¹ˆå¸ƒå‰ªä¸æ–­ï¼Ÿç­”ï¼šç€‘å¸ƒã€‚",
  "é—®ï¼šå“ªç§ç‹—ä¸å’¬äººï¼Ÿç­”ï¼šçƒ­ç‹—ã€‚",
  "é—®ï¼šå“ªç§é±¼æœ€ä¼šå†™ä½œä¸šï¼Ÿç­”ï¼šç« é±¼ï¼Œæ‰‹å¤šã€‚",
  "é—®ï¼šä»€ä¹ˆä¸œè¥¿çœ‹ä¸è§å´èƒ½è£…æ»¡æˆ¿é—´ï¼Ÿç­”ï¼šç¬‘å£°ã€‚",
  "é—®ï¼šä¸–ç•Œä¸Šæœ€å°çš„å²›ï¼Ÿç­”ï¼šå®‰å…¨å²›ã€‚",
  "é—®ï¼šä»€ä¹ˆé‹æœ€è´µï¼Ÿç­”ï¼šå­¦ï¼ˆé‹/è´¹ï¼‰ã€‚",
  "é—®ï¼šä»€ä¹ˆé’¥åŒ™æ‰“ä¸å¼€é—¨ï¼Ÿç­”ï¼šéŸ³é˜¶ do re miã€‚"
];

// =============== å†…ç½®å¤è¯—åº“ï¼ˆç¤ºä¾‹ï¼Œæ”¯æŒå¤–éƒ¨åŠ è½½è¦†ç›–ï¼‰ ===============
const POEMS_BASE = [
  {author:"æç™½",title:"é™å¤œæ€",lines:["åºŠå‰æ˜æœˆå…‰","ç–‘æ˜¯åœ°ä¸Šéœœ","ä¸¾å¤´æœ›æ˜æœˆ","ä½å¤´æ€æ•…ä¹¡"]},
  {author:"ç‹ä¹‹æ¶£",title:"ç™»é¹³é›€æ¥¼",lines:["ç™½æ—¥ä¾å±±å°½","é»„æ²³å…¥æµ·æµ","æ¬²ç©·åƒé‡Œç›®","æ›´ä¸Šä¸€å±‚æ¥¼"]},
  {author:"å­Ÿæµ©ç„¶",title:"æ˜¥æ™“",lines:["æ˜¥çœ ä¸è§‰æ™“","å¤„å¤„é—»å•¼é¸Ÿ","å¤œæ¥é£é›¨å£°","èŠ±è½çŸ¥å¤šå°‘"]},
  {author:"ç‹ç»´",title:"ç›¸æ€",lines:["çº¢è±†ç”Ÿå—å›½","æ˜¥æ¥å‘å‡ æ","æ„¿å›å¤šé‡‡æ’·","æ­¤ç‰©æœ€ç›¸æ€"]},
  {author:"æœç”«",title:"æ˜¥æœ›",lines:["å›½ç ´å±±æ²³åœ¨","åŸæ˜¥è‰æœ¨æ·±","æ„Ÿæ—¶èŠ±æº…æ³ª","æ¨åˆ«é¸ŸæƒŠå¿ƒ"]},
  {author:"æœç‰§",title:"æ¸…æ˜",lines:["æ¸…æ˜æ—¶èŠ‚é›¨çº·çº·","è·¯ä¸Šè¡Œäººæ¬²æ–­é­‚","å€Ÿé—®é…’å®¶ä½•å¤„æœ‰","ç‰§ç«¥é¥æŒ‡æèŠ±æ‘"]},
  {author:"è´ºçŸ¥ç« ",title:"å’æŸ³",lines:["ç¢§ç‰å¦†æˆä¸€æ ‘é«˜","ä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦","ä¸çŸ¥ç»†å¶è°è£å‡º","äºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€"]},
  {author:"æŸ³å®—å…ƒ",title:"æ±Ÿé›ª",lines:["åƒå±±é¸Ÿé£ç»","ä¸‡å¾„äººè¸ªç­","å­¤èˆŸè“‘ç¬ ç¿","ç‹¬é’“å¯’æ±Ÿé›ª"]},
  {author:"ç‹ç»´",title:"é¹¿æŸ´",lines:["ç©ºå±±ä¸è§äºº","ä½†é—»äººè¯­å“","è¿”æ™¯å…¥æ·±æ—","å¤ç…§é’è‹”ä¸Š"]},
  {author:"ç™½å±…æ˜“",title:"èµ‹å¾—å¤åŸè‰é€åˆ«",lines:["ç¦»ç¦»åŸä¸Šè‰","ä¸€å²ä¸€æ¯è£","é‡ç«çƒ§ä¸å°½","æ˜¥é£å¹åˆç”Ÿ"]}
];
let POEMS = POEMS_BASE.slice();

// =============== Tab åˆ‡æ¢ ===============
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const key=t.dataset.tab; document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(key).classList.remove('hidden');
}));

// =============== ç¬‘è¯æ¨¡å— ===============
const jokeText = document.getElementById('jokeText');
function showJoke(){ if(!JOKES.length){jokeText.textContent='ï¼ˆç¬‘è¯åº“ä¸ºç©ºï¼‰';return;} const i=Math.floor(Math.random()*JOKES.length); jokeText.textContent = JOKES[i]; }
document.getElementById('jokeNext').addEventListener('click', showJoke);
document.getElementById('jokeRead').addEventListener('click', ()=>{ const t=jokeText.textContent||''; if(!t) return; try{ const u=new SpeechSynthesisUtterance(t); u.lang='zh-CN'; speechSynthesis.speak(u);}catch(e){} });
document.getElementById('jokeReset').addEventListener('click', ()=>{ showJoke(); alert('å·²æ¢å¤å†…ç½®ç¬‘è¯åº“'); });
document.getElementById('jokeFile').addEventListener('change', async (ev)=>{
  const f=ev.target.files[0]; if(!f) return; const txt=await f.text();
  const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const loaded=[];
  for(const L of lines){ try{ const obj=JSON.parse(L); let text=null; for(const k of ['joke','text','content','body','title','prompt','answer']){ if(typeof obj[k]==='string'&&obj[k].trim()){text=obj[k].trim();break;} } if(!text){ if(obj.question&&obj.answer) text=obj.question+' â€” '+obj.answer; else text=JSON.stringify(obj); } loaded.push(text); }catch{ loaded.push(L); } }
  if(loaded.length){ window.JOKES = loaded; showJoke(); alert('å·²åŠ è½½å¤–éƒ¨ç¬‘è¯åº“ï¼ˆ'+loaded.length+' æ¡ï¼‰'); } else { alert('æœªè§£æåˆ°æœ‰æ•ˆç¬‘è¯'); }
});
showJoke();

// =============== å¤è¯—æ¥å¥ ===============
let currentPoem=null,currentLineIdx=0; const poemCountEl=document.getElementById('poemCount'); poemCountEl.textContent=POEMS.length;
const poemShown=document.getElementById('poemShown'), poemMeta=document.getElementById('poemMeta'), poemAnswer=document.getElementById('poemAnswer');
function normalize(s){return (s||'').replace(/\s+/g,'').replace(/[ï¼Œã€‚,.!ï¼ï¼Ÿï¼›;ï¼š:ã€ã€ã€‘\[\]ï¼ˆï¼‰()â€œâ€\"'\-â€”â€”]/g,'').trim();}
function pickRandomPoem(){ if(!POEMS.length){ alert('å¤è¯—åº“ä¸ºç©º'); return; } const i=Math.floor(Math.random()*POEMS.length); currentPoem=POEMS[i]; currentLineIdx=Math.floor(Math.random()*currentPoem.lines.length); poemShown.textContent=currentPoem.lines[currentLineIdx]; poemMeta.textContent=`${currentPoem.author} Â· ${currentPoem.title}`; poemAnswer.classList.add('hidden'); poemAnswer.textContent=''; const rv=document.getElementById('poemReveal'); if(rv) rv.classList.add('hidden'); document.getElementById('poemDirection').value='prev'; document.getElementById('poemAnswerInput').value=''; document.getElementById('progress').style.width='0%'; }

document.getElementById('poemChallenge').addEventListener('click', pickRandomPoem);

document.getElementById('poemReveal').addEventListener('click', ()=>{ if(!currentPoem) return; const idx=currentLineIdx, lines=currentPoem.lines; const prev=(idx>0)?lines[idx-1]:'ï¼ˆæ— ä¸Šä¸€å¥ï¼‰'; const next=(idx<lines.length-1)?lines[idx+1]:'ï¼ˆæ— ä¸‹ä¸€å¥ï¼‰'; poemAnswer.textContent='ä¸Šä¸€å¥ï¼š'+prev+'\nä¸‹ä¸€å¥ï¼š'+next; poemAnswer.classList.remove('hidden'); });

document.getElementById('poemSubmit').addEventListener('click', ()=>{
  if(!currentPoem){ alert('è¯·å…ˆç‚¹å‡»â€œéšæœºå‡ºé¢˜â€'); return; }
  const guess=document.getElementById('poemAnswerInput').value.trim();
  const direction=document.getElementById('poemDirection').value||'prev';
  const lines=currentPoem.lines, idx=currentLineIdx; const prev=(idx>0)?lines[idx-1]:null, next=(idx<lines.length-1)?lines[idx+1]:null; const ok = direction==='prev' ? (prev&&normalize(prev)===normalize(guess)) : (next&&normalize(next)===normalize(guess));
  const rv=document.getElementById('poemReveal'); if(!ok){ rv.classList.remove('hidden'); document.getElementById('progress').style.width='30%'; alert('âŒ ä¸æ­£ç¡®ï¼Œå¯ç‚¹å‡»â€œæŸ¥çœ‹ç­”æ¡ˆâ€'); } else { rv.classList.add('hidden'); document.getElementById('progress').style.width='100%'; alert('âœ… å›ç­”æ­£ç¡®ï¼'); }
});

// å¤–éƒ¨åŠ è½½å¤è¯—åº“ / é‡ç½®
(function(){
  const file=document.getElementById('poemFile'); if(file){ file.addEventListener('change', async (ev)=>{
    try{ const f=ev.target.files&&ev.target.files[0]; if(!f) return; const raw=await f.text(); let items=[];
      const lines=raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      for(const L of lines){ let rec=null; try{ rec=JSON.parse(L); }catch(_){ }
        if(!rec){ const t=L.split('\t'); if(t.length>=3){ rec={author:t[0], title:t[1], lines:t[2].split('|').map(x=>x.trim()).filter(Boolean)}; } }
        if(rec && Array.isArray(rec.lines) && rec.lines.length>=2){ items.push({author:String(rec.author||'ä½šå'), title:String(rec.title||'æ— é¢˜'), lines:rec.lines.map(x=>String(x))}); }
      }
      if(!items.length){ try{ const arr=JSON.parse(raw); if(Array.isArray(arr)){ for(const rec of arr){ if(rec && Array.isArray(rec.lines) && rec.lines.length>=2){ items.push({author:String(rec.author||'ä½šå'), title:String(rec.title||'æ— é¢˜'), lines:rec.lines.map(x=>String(x))}); } } } }catch(_){ }
      }
      if(!items.length){ alert('æœªè§£æåˆ°æœ‰æ•ˆå¤è¯—æ•°æ®ã€‚æ”¯æŒï¼š\n1) JSONL æ¯è¡Œ {author,title,lines:[...]}\n2) å•ä¸ª JSON æ•°ç»„\n3) author\\ttitle\\tline1|line2|...'); return; }
      POEMS = items; poemCountEl.textContent=POEMS.length; pickRandomPoem(); alert('å·²åŠ è½½å¤è¯—åº“ï¼š'+POEMS.length+' é¦–');
    }catch(e){ alert('åŠ è½½å¤è¯—åº“å¤±è´¥ï¼š'+e.message); }
  }); }
  const reset=document.getElementById('poemReset'); if(reset){ reset.addEventListener('click',()=>{ POEMS = POEMS_BASE.slice(); poemCountEl.textContent=POEMS.length; pickRandomPoem(); alert('å·²é‡ç½®ä¸ºå†…ç½®å¤è¯—åº“'); }); }
})();

// åˆå§‹å‡ºé¢˜ä¸€æ¬¡
pickRandomPoem();

/* ================= æ‰‹åŠ¿èˆï¼ˆMediapipe Hands + åŠ¨æ€ç¤ºæ„ + çƒŸèŠ±ï¼‰ ================ */
const seqsG=[
  {name:'æ¼”ç¤ºï¼ˆ6æ­¥ï¼‰',beats:['æŒ¥æ‰‹(å³)','æŒ¥æ‰‹(å·¦)','å¼ å¼€æŒ','æ¡æ‹³','ç‚¹èµ','OK']},
  {name:'ç»„åˆï¼ˆ4æ­¥ï¼‰',beats:['åˆå','çˆ±å¿ƒæ‰‹åŠ¿','åŒæ‰‹ä¸Šä¸¾','å¼ å¼€æŒ']}
];
document.getElementById('seqSelectG').innerHTML = seqsG.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
let camStreamG=null, cameraG=null, handsG=null, landmarksG=[], handednessG=[];
const videoG=document.getElementById('camG'), outG=document.getElementById('outG'), ctxG=outG.getContext('2d');
const fxG=document.getElementById('fxG'), fxCtx=fxG.getContext('2d');
let fxParts=[], fxRaf=0, lastRoiG=null; let followEnabled=false; let seqIdxG=0, pointsG=0, hitsG=0, gapG=0; let seqCurG=null; const stateG={last:{},velx:{},conf:0};

// ç¤ºæ„æµ®å±‚
const refOverlay=document.getElementById('refOverlay');
document.getElementById('showRefG').addEventListener('change',e=>{ refOverlay.style.display=e.target.checked?'block':'none'; });

document.getElementById('startCamG').addEventListener('click', async ()=>{
  try{
    if(!navigator.mediaDevices){ alert('æ­¤ç¯å¢ƒä¸æ”¯æŒæ‘„åƒå¤´ API'); return; }
    camStreamG = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}, audio:false});
    videoG.srcObject=camStreamG; await videoG.play();
    if(!window.Hands){ await ensureMediaPipe(); }
    if(window.Hands){
      handsG = new Hands({locateFile:(f)=> (document.getElementById('mpSourceG')?.value==='local' ? `./mediapipe/${f}` : `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`)});
      const mc=parseInt(document.getElementById('modelComplexityG').value,10)||1;
      const mh=parseInt(document.getElementById('maxHandsG').value,10)||1;
      handsG.setOptions({maxNumHands:mh,modelComplexity:mc,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
      handsG.onResults(onResultsG);
      cameraG = new Camera(videoG,{onFrame:async()=>{ await handsG.send({image:videoG}); },width:640,height:480}); cameraG.start();
    } else { alert('æ— æ³•åŠ è½½ Hands åº“ï¼šè¯·è”ç½‘æˆ–æŠŠåº“æ”¾åˆ°æœ¬åœ° ./mediapipe/'); }
  }catch(e){ alert('æ— æ³•å¼€å¯æ‘„åƒå¤´ï¼š'+e.message); }
});
document.getElementById('stopCamG').addEventListener('click', ()=>{ if(camStreamG){camStreamG.getTracks().forEach(t=>t.stop()); camStreamG=null;} if(cameraG){cameraG.stop();cameraG=null;} });

function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);} 
function getROIs(ptsArr,w,h){ const rois=[]; const pad=60; for(const pts of ptsArr){ if(!pts||pts.length<21) continue; let minx=1,miny=1,maxx=0,maxy=0; for(const p of pts){ if(p.x<minx)minx=p.x; if(p.x>maxx)maxx=p.x; if(p.y<miny)miny=p.y; if(p.y>maxy)maxy=p.y; } let x=minx*w-pad,y=miny*h-pad,rw=(maxx-minx)*w+pad*2,rh=(maxy-miny)*h+pad*2; x=Math.max(0,x); y=Math.max(0,y); rw=Math.min(w-x,rw); rh=Math.min(h-y,rh); rois.push({x,y,rw,rh}); } return rois; }
function renderBG(ptsArr){ outG.width=videoG.videoWidth||640; outG.height=videoG.videoHeight||480; const rois=getROIs(ptsArr,outG.width,outG.height); const orig=document.createElement('canvas'); orig.width=outG.width; orig.height=outG.height; const octx=orig.getContext('2d'); octx.drawImage(videoG,0,0,orig.width,orig.height); ctxG.save(); if(document.getElementById('blurBgG').checked) ctxG.filter='blur(6px)'; ctxG.drawImage(orig,0,0,orig.width,orig.height); ctxG.filter='none'; ctxG.restore(); if(document.getElementById('dimBgG').checked){ ctxG.save(); ctxG.fillStyle='rgba(0,0,0,0.35)'; ctxG.fillRect(0,0,outG.width,outG.height); ctxG.globalCompositeOperation='destination-out'; for(const r of rois) ctxG.fillRect(r.x,r.y,r.rw,r.rh); ctxG.restore(); } if(rois.length){ ctxG.save(); ctxG.beginPath(); for(const r of rois) ctxG.rect(r.x,r.y,r.rw,r.rh); ctxG.clip(); ctxG.drawImage(orig,0,0,orig.width,orig.height); ctxG.restore(); } if(document.getElementById('showROIG').checked && rois.length){ let rx=rois[0].x, ry=rois[0].y, rw=rois[0].rw, rh=rois[0].rh; for(let i=1;i<rois.length;i++){ const r=rois[i]; const nx=Math.min(rx,r.x), ny=Math.min(ry,r.y), mx=Math.max(rx+rw,r.x+r.rw), my=Math.max(ry+rh,r.y+r.rh); rx=nx;ry=ny;rw=mx-rx;rh=my-ry; } ctxG.save(); ctxG.strokeStyle='rgba(255,255,255,0.85)'; ctxG.lineWidth=3; ctxG.setLineDash([8,6]); ctxG.strokeRect(rx,ry,rw,rh); ctxG.restore(); } return rois; }
function onResultsG(res){ const ptsArr = res.multiHandLandmarks||[]; landmarksG=ptsArr; handednessG=(res.multiHandedness||[]).map(h=>h.label); const rois=renderBG(ptsArr); // åŒæ­¥çƒŸèŠ±ç”»å¸ƒå°ºå¯¸
  if(fxG && (fxG.width!==outG.width || fxG.height!==outG.height)){ fxG.width=outG.width; fxG.height=outG.height; }
  // è®°å½•æ‰‹éƒ¨åŒºåŸŸï¼ˆç”¨äºæŠŠçƒŸèŠ±æ”¾åœ¨äººç‰©é™„è¿‘ï¼‰
  if(rois && rois.length){ let rx=rois[0].x, ry=rois[0].y, rw=rois[0].rw, rh=rois[0].rh; for(let i=1;i<rois.length;i++){ const r=rois[i]; const nx=Math.min(rx,r.x), ny=Math.min(ry,r.y), mx=Math.max(rx+rw,r.x+r.rw), my=Math.max(ry+rh,r.y+r.rh); rx=nx; ry=ny; rw=mx-rx; rh=my-ry; } lastRoiG={x:rx,y:ry,rw:rw,rh:rh}; } else { lastRoiG=null; }
  if(landmarksG.length){ for(let i=0;i<landmarksG.length;i++){ drawConnectors(ctxG,landmarksG[i],HAND_CONNECTIONS,{color:'#ffffff',lineWidth:5}); drawConnectors(ctxG,landmarksG[i],HAND_CONNECTIONS,{color:'#0ea5e9',lineWidth:2}); drawLandmarks(ctxG,landmarksG[i],{color:'#ffffff',lineWidth:2,radius:3}); drawLandmarks(ctxG,landmarksG[i],{color:'#0ea5e9',lineWidth:1,radius:2}); } } updateRefOverlayPosition(rois); classifyG(); }
function extractF(){ const F={L:null,R:null}; for(let i=0;i<landmarksG.length;i++){ const label=handednessG[i]||'Right', pts=landmarksG[i]; if(!pts||pts.length<21) continue; const wrist=pts[0], thumbTip=pts[4], indexTip=pts[8], middleTip=pts[12], ringTip=pts[16], pinkyTip=pts[20], indexMcp=pts[5], middleMcp=pts[9], ringMcp=pts[13], pinkyMcp=pts[17]; const palmW=dist(indexMcp,pinkyMcp)+1e-6, palmH=dist(wrist,middleTip)+1e-6, spread=dist(thumbTip,pinkyTip)/palmW; const extIndex=dist(indexTip,indexMcp)/palmH, extMiddle=dist(middleTip,middleMcp)/palmH, extRing=dist(ringTip,ringMcp)/palmH, extPinky=dist(pinkyTip,pinkyMcp)/palmH; const k=(label==='Left')?'L':'R'; const last=stateG.last[k]; let velx=0; if(last) velx=Math.abs(wrist.x-last.x); stateG.last[k]={x:wrist.x,y:wrist.y}; stateG.velx[k]=(stateG.velx[k]||0)*0.75+velx*0.25; F[k]={y_wrist:wrist.y, spread, extIndex, extMiddle, extRing, extPinky, horiz:wrist.x, velx:stateG.velx[k]}; } return F; }
function classifyG(){ const F=extractF(); let label='æœªçŸ¥',conf=0; const R=F.R; if(R){ if(R.spread>0.60 && R.y_wrist<0.6){ label='å¼ å¼€æŒ'; conf=Math.max(conf,0.7); } if(R.extIndex>0.75 && R.extMiddle>0.75 && R.extRing<0.65){ label='æ¯”V'; conf=Math.max(conf,0.68); } if(R.extIndex<0.55 && R.extMiddle<0.55){ label='æ¡æ‹³'; conf=Math.max(conf,0.62); } if(R.spread>0.6 && R.y_wrist<0.55){ label='ç‚¹èµ'; conf=Math.max(conf,0.6); } if(R.velx>0.012){ label='æŒ¥æ‰‹(å³)'; conf=Math.max(conf, Math.min(1,(R.velx-0.012)/0.02)); } } stateG.conf = stateG.conf*0.7 + conf*0.3; document.getElementById('predG').textContent=label; document.getElementById('confG').textContent=(stateG.conf||0).toFixed(2); const needN=parseInt(document.getElementById('needFramesG').value,10)||2; const thr=parseFloat(document.getElementById('thrG').value)||0.55; const cur=getCurSeq(); const needLabel = cur && cur.beats[seqIdxG]; const matched=(needLabel && label===needLabel && (stateG.conf||0)>=thr); if(matched){ hitsG+=1; gapG=0; } else { if(hitsG>0 && gapG<1){ gapG+=1; } else { hitsG=0; gapG=0; } } document.getElementById('frameFillG').style.width=Math.min(100,Math.round(100*hitsG/needN))+'%'; if(hitsG>=needN){ hitsG=0; gapG=0; pointsG+=10; celebrateG('pass'); nextStepG(); } renderBeatGuide(); }

function getCurSeq(){ const sel=document.getElementById('seqSelectG'); const idx=parseInt(sel.value||'0',10)||0; seqCurG=seqsG[idx]||{beats:[]}; return seqCurG; }
function nextStepG(){ const cur=getCurSeq(); seqIdxG+=1; if(seqIdxG>=cur.beats.length){ celebrateG('complete'); alert('å®Œæˆèˆåºï¼å¾—åˆ†:'+pointsG); seqIdxG=0; } renderBeatGuide(true); }

// â€”â€” æ˜¾ç¤ºæ¯ä¸€æ‹éœ€è¦è·Ÿçš„å†…å®¹ï¼ˆå åŠ  + ä¾§è¾¹å¼•å¯¼ + è¯­éŸ³ + åŠ¨æ€ç¤ºæ„å›¾ï¼‰
function renderBeatGuide(forceSpeak=false){
  const cur=getCurSeq();
  const now = cur.beats[seqIdxG] || 'â€”';
  const next = cur.beats[seqIdxG+1] || 'å®Œæˆ';
  const overlay=document.getElementById('beatOverlay'); if(overlay){ overlay.textContent='è¯·åšï¼š'+now; overlay.style.display=(document.getElementById('overlayBeatG')?.checked)?'block':'none'; }
  const nowEl=document.getElementById('beatNow'); if(nowEl) nowEl.textContent=now;
  const nextEl=document.getElementById('beatNext'); if(nextEl) nextEl.textContent=next;
  const strip=document.getElementById('beatStrip'); if(strip){ strip.innerHTML = cur.beats.map((b,i)=>{ const cls = i<seqIdxG? 'badge done' : (i===seqIdxG? 'badge active':'badge'); return `<span class="${cls}">${i+1}. ${b}${i<seqIdxG?' âœ“':''}</span>`; }).join(''); }
  setRefDynamic(now);
  if((forceSpeak || false) && document.getElementById('speakBeatG')?.checked && 'speechSynthesis' in window){ try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(now); u.lang='zh-CN'; speechSynthesis.speak(u);}catch(_){}}
}

document.getElementById('playSeqG').addEventListener('click',()=>{ seqIdxG=0; renderBeatGuide(true); });
document.getElementById('skipG').addEventListener('click',()=>{ nextStepG(); });
document.getElementById('resetSeqG').addEventListener('click',()=>{ seqIdxG=0; pointsG=0; hitsG=0; gapG=0; renderBeatGuide(true); });
document.getElementById('seqSelectG').addEventListener('change',()=>{ seqIdxG=0; renderBeatGuide(true); });
document.getElementById('overlayBeatG')?.addEventListener('change',()=>renderBeatGuide());

document.getElementById('followRefG').addEventListener('change',e=>{ followEnabled = !!e.target.checked; if(!followEnabled){ refOverlay.style.left='8px'; refOverlay.style.top='8px'; }});
function updateRefOverlayPosition(rois){ if(!followEnabled||!rois||!rois.length) return; const r=rois[0]; const overlay=refOverlay; const ow=overlay.offsetWidth||190, oh=overlay.offsetHeight||180; const targetLeft=Math.round(r.x+r.rw/2-ow/2), targetTop=Math.round(r.y-oh-8); const leftClamped=Math.max(4,Math.min(targetLeft,(outG.width-ow-4))); const topClamped=Math.max(4,Math.min(targetTop,(outG.height-oh-4))); overlay.style.left=leftClamped+'px'; overlay.style.top=topClamped+'px'; }

// â€”â€” åŠ¨æ€ç¤ºæ„å›¾ï¼ˆæŒ‰æ‰‹åŠ¿åé€‰æ‹©åŠ¨ç”»ç±»å‹ï¼‰
function dynamicSpec(name){ name=String(name||'');
  if(name.includes('æŒ¥æ‰‹(å³)') || name.includes('æŒ¥æ‰‹(å·¦)') || name.includes('æŒ¥æ‰‹')) return {emoji:'ğŸ‘‹', cls:'anim-waveX', hint:name.includes('å·¦')?'å‘å·¦æŒ¥æ‰‹':'å‘å³æŒ¥æ‰‹', arrow:name.includes('å·¦')?'â†â†’':'â†’â†'};
  if(name.includes('æ¡æ‹³')) return {emoji:'âœŠ', cls:'anim-pulse', hint:'æ¡æ‹³', arrow:'Â·'};
  if(name.includes('ç‚¹èµ')) return {emoji:'ğŸ‘', cls:'anim-bounce', hint:'ç‚¹èµ', arrow:'â†‘'};
  if(/^OK|ï¼¯ï¼«|ok/i.test(name)) return {emoji:'ğŸ‘Œ', cls:'anim-sway', hint:'OK æ‰‹åŠ¿', arrow:'Â·'};
  if(name.includes('æ¯”V')||name.includes('Vå­—')) return {emoji:'âœŒ', cls:'anim-sway', hint:'æ¯” V', arrow:'Â·'};
  if(name.includes('åˆå')) return {emoji:'ğŸ™', cls:'anim-updown', hint:'åŒæ‰‹åˆå', arrow:'â†•'};
  if(name.includes('çˆ±å¿ƒ')) return {emoji:'ğŸ«¶', cls:'anim-heart', hint:'çˆ±å¿ƒæ‰‹åŠ¿', arrow:'â¤'};
  if(name.includes('ä¸Šä¸¾')||name.includes('ä¸¾æ‰‹')) return {emoji:'ğŸ™Œ', cls:'anim-updown', hint:'åŒæ‰‹ä¸Šä¸¾', arrow:'â†•'};
  if(/å¼ å¼€æŒ|å¼ å¼€|æŒ|open/i.test(name)) return {emoji:'ğŸ–', cls:'anim-pulse', hint:'å¼ å¼€æŒ', arrow:'Â·'};
  return {emoji:'âœ‹', cls:'anim-sway', hint:name||'æ‰‹åŠ¿', arrow:'Â·'};
}
function setRefDynamic(name){ const wrap=document.getElementById('refOverlay'); const host=document.getElementById('refAnimG'); if(!host||!wrap) return; const spec=dynamicSpec(name); host.innerHTML = `<div class="animEmoji ${spec.cls}">${spec.emoji}</div><div class="animArrow">${spec.arrow}</div><div class="animHint">${name} Â· ${spec.hint}</div>`; wrap.style.display = (document.getElementById('showRefG')?.checked)?'block':'none'; }

// â€”â€” çƒŸèŠ±/å½©å¸¦ç‰¹æ•ˆ â€”â€”
const FX_PALETTE=['#ffca3a','#8ac926','#1982c4','#6a4c93','#ff595e','#ffffff'];
function spawnBurst(x,y,count){
  for(let i=0;i<count;i++){
    const ang=Math.random()*Math.PI*2;
    const sp=(Math.random()*2.5+1.5)*(Math.random()<0.3?2:1);
    fxParts.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp - Math.random()*0.5,life:60+Math.random()*40,color:FX_PALETTE[(Math.random()*FX_PALETTE.length)|0],size:2+Math.random()*2,g:0.035});
  }
}
function runFx(){ if(fxRaf) return; const step=()=>{ fxRaf=requestAnimationFrame(step); if(!fxG) return; fxCtx.clearRect(0,0,fxG.width,fxG.height); fxCtx.globalCompositeOperation='lighter'; for(let i=fxParts.length-1;i>=0;i--){ const p=fxParts[i]; p.vx*=0.985; p.vy*=0.985; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.life-=1; if(p.life<=0){ fxParts.splice(i,1); continue; } fxCtx.beginPath(); fxCtx.arc(p.x,p.y,p.size,0,Math.PI*2); fxCtx.fillStyle=p.color; fxCtx.fill(); } fxCtx.globalCompositeOperation='source-over'; if(fxParts.length===0){ cancelAnimationFrame(fxRaf); fxRaf=0; fxCtx.clearRect(0,0,fxG.width,fxG.height);} }; step(); }
function celebrateG(kind='pass'){
  if(!fxG) return; const cx= lastRoiG? (lastRoiG.x+lastRoiG.rw/2) : (fxG.width/2); const cy= lastRoiG? (lastRoiG.y+Math.max(0,lastRoiG.rh*0.2)) : (fxG.height*0.35);
  const bursts = (kind==='complete')?6:3; for(let i=0;i<bursts;i++){ const ang=Math.random()*Math.PI*2; const r=(kind==='complete'? (Math.random()*120+40) : (Math.random()*60+30)); spawnBurst(cx+Math.cos(ang)*r, cy+Math.sin(ang)*r, kind==='complete'?90:60); }
  runFx();
}

// åˆæ¬¡æ¸²æŸ“ä¸€æ¬¡
renderBeatGuide(true);

/* ============ é¢„è®¾ & ç¨³å¥åŠ è½½ï¼ˆæœ¬åœ°/CDNï¼‰ & è‡ªæ£€/æ¼”ç¤º =========== */
function applyPreset(p){ if(!window.handsG) return; if(p==='student'){ handsG.setOptions({modelComplexity:0,maxNumHands:1,minDetectionConfidence:0.5,minTrackingConfidence:0.5}); document.getElementById('thrG').value=0.55; document.getElementById('needFramesG').value=2; } else if(p==='demo'){ handsG.setOptions({modelComplexity:1,maxNumHands:2,minDetectionConfidence:0.6,minTrackingConfidence:0.6}); document.getElementById('thrG').value=0.65; document.getElementById('needFramesG').value=3; } else if(p==='precise'){ handsG.setOptions({modelComplexity:2,maxNumHands:2,minDetectionConfidence:0.75,minTrackingConfidence:0.75}); document.getElementById('thrG').value=0.75; document.getElementById('needFramesG').value=4; } }
document.getElementById('presetG').addEventListener('change',e=>{ try{ applyPreset(e.target.value); }catch(_){} });
document.getElementById('modelComplexityG').addEventListener('change',e=>{ try{ handsG && handsG.setOptions({modelComplexity:parseInt(e.target.value,10)});}catch(_){}} );
document.getElementById('maxHandsG').addEventListener('change',e=>{ try{ handsG && handsG.setOptions({maxNumHands:parseInt(e.target.value,10)});}catch(_){}} );

async function addScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(src); s.onerror=()=>rej(new Error('åŠ è½½å¤±è´¥: '+src)); document.head.appendChild(s); }); }
async function loadMediaPipePrefer(source){ const paths = (source==='local') ? ['./mediapipe/hands.js','./mediapipe/camera_utils.js','./mediapipe/drawing_utils.js'] : ['https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js','https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js','https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js']; for(const p of paths){ await addScript(p); } return true; }
async function ensureMediaPipe(){ if(window.Hands && window.Camera) return true; const sel=document.getElementById('mpSourceG'); const want=sel?sel.value:'cdn'; try{ await loadMediaPipePrefer(want); return true; }catch(e){ if(want==='local'){ try{ await loadMediaPipePrefer('cdn'); return true; }catch(e2){ return false; } } return false; } }

function diagAppend(msg){ const p=document.getElementById('diagPanelG'); if(p) p.textContent=(p.textContent||'')+msg+'\n'; }
function ok(x){return 'âœ… '+x} function bad(x){return 'âŒ '+x} function info(x){return 'â„¹ï¸ '+x}
async function runDiag(){ const panel=document.getElementById('diagPanelG'); if(panel) panel.textContent=''; const prot=location.protocol, host=location.hostname; const isSecure=(prot==='https:'||host==='localhost'||host==='127.0.0.1'); diagAppend((isSecure?ok:bad)('é¡µé¢ä¸Šä¸‹æ–‡ï¼š'+prot+'//'+location.host+'ï¼ˆå»ºè®® https æˆ– localhostï¼‰')); if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ diagAppend(bad('æ­¤ç¯å¢ƒä¸æ”¯æŒæ‘„åƒå¤´ API')); } else { try{ const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); s.getTracks().forEach(t=>t.stop()); diagAppend(ok('æ‘„åƒå¤´æƒé™å¯ç”¨')); }catch(e){ diagAppend(bad('æ‘„åƒå¤´æƒé™å¤±è´¥ï¼š'+e.message)); } } const okMP = await ensureMediaPipe(); diagAppend((okMP?ok:bad)('MediaPipe åº“åŠ è½½'+(okMP?'æˆåŠŸ':'å¤±è´¥'))); if(!okMP) diagAppend(info('ç¦»çº¿ï¼šæŠŠ hands.js / camera_utils.js / drawing_utils.js æ”¾åˆ° ./mediapipe/ å¹¶é€‰æ‹©â€œæœ¬åœ°â€ï¼›æˆ–æ”¹ç”¨ CDNï¼ˆè”ç½‘ï¼‰ã€‚')); diagAppend(info('è‡ªæ£€å®Œæˆ')); }
document.getElementById('btnDiagG').addEventListener('click',runDiag);
document.getElementById('btnDemoG').addEventListener('click',()=>{ const canvas=outG, ctx=canvas.getContext('2d'); canvas.width=640; canvas.height=360; ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#fff'; ctx.font='20px system-ui'; ctx.fillText('æ¼”ç¤ºæ¨¡å¼ï¼šæœªå¯ç”¨æ‘„åƒå¤´',20,40); ctx.fillText('å°†æ¨¡æ‹Ÿï¼šæŒ¥æ‰‹(å³) -> æ¡æ‹³ -> å¼ å¼€æŒ',20,70); const seqSim=['æŒ¥æ‰‹(å³)','æ¡æ‹³','å¼ å¼€æŒ']; let i=0; setInterval(()=>{ document.getElementById('predG').textContent=seqSim[i%seqSim.length]; document.getElementById('confG').textContent='0.95'; document.getElementById('frameFillG').style.width='100%'; i++; },1200); });

document.getElementById('startCamG').addEventListener('click',()=>{ const okCtx=(location.protocol==='https:'||location.hostname==='localhost'||location.hostname==='127.0.0.1'); if(!okCtx){ setTimeout(()=>{ alert('æç¤ºï¼šå¤šæ•°æµè§ˆå™¨åœ¨ file:// æˆ–éå®‰å…¨ä¸Šä¸‹æ–‡æ— æ³•å¯ç”¨æ‘„åƒå¤´ã€‚è¯·ç”¨ https æˆ–æœ¬åœ°å°æœåŠ¡å™¨ï¼š\n\npython -m http.server 8000\n\nç„¶åç”¨ http://<ä½ çš„è®¾å¤‡IP>:8000/ æ‰“å¼€æœ¬é¡µã€‚'); },1200); } });
</script>

<script>
// --- è¿è¡Œæ—¶å…œåº•ï¼šå³ä½¿è„šæœ¬æŠ¥é”™ä¹Ÿèƒ½åˆ‡æ¢ tabï¼Œå¹¶æ˜¾ç¤ºç®€è¦é”™è¯¯ ---
(function(){
  if(!document.getElementById('globalErr2')){
    const box=document.createElement('div');
    box.id='globalErr2';
    box.style.cssText='position:fixed;left:8px;bottom:8px;background:#fff3f3;border:1px solid #ffd6d6;color:#8a1616;padding:6px 8px;border-radius:8px;font-size:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);display:none;z-index:9999;max-width:70vw;white-space:pre-wrap;';
    document.body.appendChild(box);
    const show=(m)=>{ box.textContent='è„šæœ¬æç¤ºï¼š'+m; box.style.display='block'; };
    window.addEventListener('error',e=>{ show(e.message||String(e.error||e)); });
    window.addEventListener('unhandledrejection',e=>{ show('Promise å¤±è´¥ï¼š'+(e.reason && e.reason.message || String(e.reason))); });
  }
  document.addEventListener('click', function(ev){ const btn=ev.target.closest && ev.target.closest('.tab'); if(!btn) return; try{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const key=btn.getAttribute('data-tab'); document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden')); const sec=document.getElementById(key); if(sec) sec.classList.remove('hidden'); }catch(_){ }
  }, true);
  const rv=document.getElementById('poemReveal'); if(rv){ rv.classList.add('hidden'); }
})();
</script>
</body>
</html>
